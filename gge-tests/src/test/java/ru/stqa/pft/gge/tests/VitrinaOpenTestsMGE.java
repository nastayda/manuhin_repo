package ru.stqa.pft.gge.tests;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.thoughtworks.xstream.XStream;
import org.openqa.selenium.By;
import org.testng.annotations.DataProvider;
import org.testng.annotations.Test;
import ru.stqa.pft.gge.model.GeneratorData;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.Iterator;
import java.util.List;
import java.util.stream.Collectors;

import static org.hamcrest.CoreMatchers.equalTo;
import static org.hamcrest.MatcherAssert.assertThat;

/**
 * Created by manuhin on 31.05.2016.
 */
public class VitrinaOpenTestsMGE extends TestBase{

  @DataProvider
  public Iterator<Object[]> validGroupsFromXml() throws IOException {
    try (BufferedReader reader = new BufferedReader(new FileReader(
            new File("src/test/resources/vitrinas3.xml")))) {
      String xml = "";
      String line = reader.readLine();
      while (line != null) {
        xml += line;
        line = reader.readLine();
      }
      XStream xstream = new XStream();
      xstream.processAnnotations(GeneratorData.class);
      List<GeneratorData> vitrinas = (List<GeneratorData>) xstream.fromXML(xml);
      return vitrinas.stream().map((g) -> new Object[] {g}).collect(Collectors.toList()).iterator();
    }
  }
  public class Testdata {
    //ссылки и эксклюзивные данные тестируемого сервера
    //имя домена для всех ссылок
    String domen = "https://expertiza.mos.ru";
    //логин пользователя освобождающего логин adminMGE, нужен при терминированном доступе.
    String userlogout = "VASILENKORN";
    //универсальный пароль
    String password = "Yjdsq№7Ujl";

  }
  @DataProvider
  public Iterator<Object[]> validGroupsFromJson() throws IOException {
    //BEG Переменные для теста. Для предбоя:
    //String domen = "https://expertiza-tech.mos.ru";
    // userlogout = "VASILENKORN";
    //END Переменные для теста. Для предбоя:
    Testdata testdata = new Testdata();
    String domen = testdata.domen;
    try (BufferedReader reader = new BufferedReader(new FileReader(
            //new File("src/test/resources/vitrinas_mge_galactica_admin1_all_expertiza_new2.json")))) { //по боевому
            new File("src/test/resources/vitrinas_mge_galactica_admin1_all_expertiza_new2_96.json")))) { //по тестовому 96
        String json = "";
      String line = reader.readLine();
      while (line != null) {
        //line = line.replace("/portal", "https://expertiza-tech.mos.ru/portal");
        json += line;
        line = reader.readLine();
      }
      json = json.replace("/portal", domen + "/portal");
      Gson gson = new Gson();
      List<GeneratorData> vitrinas = gson.fromJson(json, new TypeToken<List<GeneratorData>>(){}.getType()); // List<GroupData>.class
      return vitrinas.stream().map((g) -> new Object[] {g}).collect(Collectors.toList()).iterator();
    }
  }

  @Test(dataProvider = "validGroupsFromJson", timeOut = 250000)
  public void testVitrinaOpenAndFindMGE(GeneratorData vitrina) throws Exception {
    Testdata testdata = new Testdata();
    boolean isProdServer = false;
    String password = testdata.password;
    if (isProdServer) {
      password = "Yjdsq№7Ujl";
    }

    //BEG Переменные для теста. Для предбоя:
    String domen = testdata.domen;
    String userlogout = testdata.userlogout;

    //END Переменные для теста. Для предбоя:

//    assertThat(app.successInit, equalTo(true));
//    app.session().loginGGEMGE(vitrina.getLoginUser(), password, vitrina.getBaseUrl());
//
//    assertThat(app.vitrina().selectVitrina(vitrina, isProdServer), equalTo(true));
//    if (app.vitrina().checkVitrinaIs(vitrina, isProdServer)) {
//      assertThat(app.vitrina().isMistakes(isProdServer), equalTo(false));
//      app.vitrina().vizovRasshPoiskMGE(isProdServer);
//      app.vitrina().fillAllFilters(isProdServer);
//      app.vitrina().buttonFind(isProdServer);
//      assertThat(app.vitrina().isMistakes(isProdServer), equalTo(false));
//    } else {
//      assertThat(app.vitrina().isMistakesOtchet(isProdServer), equalTo(false));
//    }
    //BEG разлогинивание перед тестом, стало нужно если включен терминированный доступ
    app.session().logout(domen, password, userlogout, vitrina.getLoginUser());
    //END разлогинивание перед тестом, стало нужно если включен терминированный доступ
    assertThat(app.successInit, equalTo(true));
    app.session().loginGGEMGE(vitrina.getLoginUser(), password, vitrina.getBaseUrl());

    assertThat(app.vitrina().selectVitrinaMGE(vitrina, isProdServer), equalTo(true));
    assertThat(app.vitrina().isMistakesMGE(isProdServer), equalTo(false));

    //app.vitrina().vizovRasshPoiskMGE(isProdServer); //вызов формы поиска.
    //app.vitrina().fillAllFilters(isProdServer); // заполнение полей формы поиска.
    //app.vitrina().buttonFind(isProdServer); // клик на кнопку поиска.
    assertThat(app.vitrina().isMistakesMGE(isProdServer), equalTo(false));
    //app.session().logout();
    //click(By.xpath('//span[@id=\'logoutMethod\']//a[.=\'Выход\']'));
  }
}
